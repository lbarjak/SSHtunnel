SSHtunnel - fontos információk
===============================

Ez a fájl tartalmazza a létrehozott Spring Boot változat fontos részleteit, hogy a `SSHtunnel` mappát át tudod helyezni és ott folytatni a munkát.

Fájlok és helyek
- **Spring Boot modul:** `SSHtunnel/`
- **Maven POM:** `SSHtunnel/pom.xml`
- **Main class:** `eu.barjak.sshtunnel.SshtunnelApplication` (fájl: `SSHtunnel/src/main/java/eu/barjak/sshtunnel/SshtunnelApplication.java`)
- **Service:** `eu.barjak.sshtunnel.MqttTunnelService` (fájl: `SSHtunnel/src/main/java/eu/barjak/sshtunnel/MqttTunnelService.java`)
- **Konfig:** `SSHtunnel/src/main/resources/application.properties`
- **README:** `SSHtunnel/README.md`
- **Eredeti egyszerű Java alkalmazás:** `src/main/java/Sshtunnel.java` (a projekt gyökérében)

Milyen a cél
- A Spring Boot verzió ugyanazt a funkciót valósítja meg mint az eredeti `Sshtunnel.java`: csatlakozik MQTT brokerhez (Eclipse Paho), feliratkozik `zigbee2mqtt/#`-ra, figyeli az üzenetek érkezését, és ha nincs üzenet egy konfigurálható timeout ideje alatt, újraindítja az SSH tunnelt (pkill + ssh parancsok) és újracsatlakozik.

Gyors build és futtatás
- Build (a projekt gyökéréből vagy a `SSHtunnel` mappából):

```bash
cd SSHtunnel
mvn package
```

- Futtatás fejlesztés alatt (Spring Boot plugin):

```bash
mvn spring-boot:run
```

- Ha elkészült a JAR, futtatható így:

```bash
java -jar target/sshtunnel-spring-1.0-SNAPSHOT.jar
```

Konfiguráció (alapértelmezett értékek)
- `application.properties` (hely: `SSHtunnel/src/main/resources/application.properties`):
  - `mqtt.broker` = `tcp://localhost:1883`
  - `mqtt.topic` = `zigbee2mqtt/#`
  - `ssh.cmd` = (do NOT store production commands in the repo; set via env var `SSH_CMD` or local config)
  - `pkill.cmd` = (do NOT store production commands in the repo; set via env var `PKILL_CMD` or local config)
  - `timeout.seconds` = `60`

Megjegyzések a konfigurációról
- Ezeket felülírhatod környezeti változókkal, JVM system property-kkel vagy parancssori argumentummal (Spring Boot szabványos módon). Példa futtatáskor property átadásra:

```bash
mvn spring-boot:run -Dspring-boot.run.arguments="--mqtt.broker=tcp://example:1883 --timeout.seconds=120"
```

Fontos viselkedés és üzemeltetési megjegyzések
- A service (MqttTunnelService) a Paho MQTT kliens `automaticReconnect=true` és `cleanSession=true` beállítással használja.
- Üzenet érkezésekor a `lastMessageTime` frissül; ha a megadott `timeout.seconds` alatt nincs új üzenet, a service:
  1) lefuttatja a `pkill.cmd` parancsot (megölheti a korábbi ssh folyamatot),
  2) lefuttatja a `ssh.cmd` parancsot (új tunnelt indít),
  3) újracsatlakozik a brokerhez és újra feliratkozik a topic-ra.
- A `ssh.cmd` nem tartalmaz éles értéket a repo-ban; a valós parancsokat ne tárold verziókövetett fájlokban. Helyette használd a `application.properties.example` fájlt és állítsd be a konkrét értékeket környezeti változóként vagy lokális, nem követett config fájlban.
- A parancsok futtatása helyi környezetben történik: a Spring alkalmazásnak legyen jogosultsága ssh-t indítani/megölni, és legyenek hozzá egy működő SSH kulcsaid ha szükséges (nincs automatikus jelszó-kezelés).

Logolás és hibakeresés
- A service System.out/System.err-re ír alapvető üzeneteket. Ha bővebb logolást akarsz, érdemes `spring-boot-starter-logging` (alapértelmezett) konfigurálni és a `org.eclipse.paho` vagy `eu.barjak.sshtunnel` logolási szintjét emelni az `application.properties`-ben.

Fejlesztési és terjesztési megjegyzések
- A Spring Boot modul külön Maven modulként is használható a gyökér `pom.xml`-ben multi-module projektként. Jelenleg egyszerű, különálló modul `SSHtunnel/` mappában.
- Spring Boot verzió: `2.7.15` (meghatározva a `SSHtunnel/pom.xml`-ben). Java 11 a cél (`java.version=11`).

Hogyan tovább miután áthelyezed a mappát
- A mappa tartalma önállóan építhető másik gépen, ha a `pom.xml` és a `src/` mappa megmarad.
- Ellenőrizd, hogy az új környezetben a `java` és `mvn` elérhető-e, és a szükséges SSH kulcsok/hozzáférések adottak.

Gyakori problémák és megoldások
- "Nem tud csatlakozni az MQTT brokerhez": ellenőrizd `mqtt.broker` URL-t és hálózati elérést (tűzfal, port forwarding). A Spring logban látszik a csatlakozási hiba.
- "ssh parancs nem indul/joga nincs": futtasd manuálisan a `ssh.cmd`-ban szereplő parancsot a felhasználóval, vagy módosítsd `pkill.cmd`-et pontosabb keresésre.
- "A pkill megöl más ssh folyamatokat": finomítsd a `pkill` keresőkifejezést, vagy használj dedikált ControlMaster/ControlPath beállítást az ssh-hoz.

Kapcsolódó fájlok gyors áttekintése
- `SSHtunnel/pom.xml` — Spring Boot parent, dependency-k (Paho MQTT)
- `SSHtunnel/src/main/java/eu/barjak/sshtunnel/SshtunnelApplication.java` — `@SpringBootApplication` belépési pont
- `SSHtunnel/src/main/java/eu/barjak/sshtunnel/MqttTunnelService.java` — a működő logika (MQTT callback, monitor, runCommand)

Utolsó státusz (a fájl készítésekor)
- A Spring modul létrehozva a `SSHtunnel/` alatt.
- A `mvn -f SSHtunnel/pom.xml package` parancs még nem futott le itt; ha kéred, lefuttatom a build-et és javítom az esetleges függőségi/fordítási hibákat.

-- vége --
